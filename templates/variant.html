<!DOCTYPE html>
<html lang="ru">
   <!-- Basic -->
   <meta charset="utf-8">
   <meta http-equiv="X-UA-Compatible" content="IE=edge">
   <script src="https://vk.com/js/api/openapi.js?169" type="text/javascript"></script>
   <!-- Mobile Metas -->
   <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
   <!-- Site Metas -->
   <title>Сдай Егэ</title>
   <meta name="keywords" content="">
   <meta name="description" content="">
   <meta name="author" content="">
   <!-- Site Icons -->
   <link rel="shortcut icon" href="{{ url_for('static', filename='images/лого.jpg') }}" type="image/x-icon" />
   <!-- Bootstrap CSS -->
   <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap.min.css') }}">
   <!-- Site CSS -->
   <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
   <!-- Responsive CSS -->
   <link rel="stylesheet" href="{{ url_for('static', filename='css/responsive.css') }}">
   <!-- Custom CSS -->
   <link rel="stylesheet" href="{{ url_for('static', filename='css/custom.css') }}">
   <link rel="stylesheet" href="{{ url_for('static', filename='css/owl.carousel.css') }}">
   <link rel="stylesheet" href="{{ url_for('static', filename='css/animate.css') }}">
   <link rel="stylesheet" href="{{ url_for('static', filename='css/flaticon.css') }}">
   <link rel="stylesheet" href="{{ url_for('static', filename='css/prettyPhoto.css') }}">
   <link rel="stylesheet" href="{{ url_for('static', filename='css/font-awesome.min.css') }}">
   <link rel="stylesheet" href="{{ url_for('static', filename='css/tasks.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.2.3/purify.min.js"></script>
    <script type="module">
      import { marked } from "https://cdn.jsdelivr.net/npm/marked/lib/marked.esm.js";
      document.querySelectorAll('.markdown').forEach((e) => {
        e.innerHTML = DOMPurify.sanitize(marked.parse(e.innerText));
      });
    </script>
   <script src="{{ url_for('static', filename='js/modernizr.js') }}"></script> <!-- Modernizr -->
   <!--[if lt IE 9]>
   <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
   <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
   <![endif]-->
   <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      jax: ["input/TeX", "output/HTML-CSS"],
      extensions: ["tex2jax.js"],
      "HTML-CSS": { preferredFont: "TeX", availableFonts: ["STIX","TeX"] },
      tex2jax: { inlineMath: [ ["$", "$"], ["\\(","\\)"] ], displayMath: [ ["$$","$$"], ["\\[", "\\]"] ], processEscapes: true, ignoreClass: "tex2jax_ignore|dno" },
      TeX: { noUndefined: { attributes: { mathcolor: "red", mathbackground: "#FFEEEE", mathsize: "90%" } } },
      messageStyle: "none"
    });
    </script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js"></script>

   <body id="page-top" class="politics_version">
      <!-- Navigation -->
      <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
         <div class="container-fluid">
            <a class="navbar-brand " target="_blank">
            <img class="img-thumbnail" src="{{ url_for('static', filename='images/kegeh.png') }}" alt="" width="200" />
            </a>
            <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
            Главная
            <i class="fa fa-bars"></i>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
               <ul class="navbar-nav">
                  <div class="collapse navbar-collapse" id="navbarResponsive">
                     <ul class="navbar-nav text-uppercase ml-auto">
                        <li class="nav-item">
                           <a class="nav-link js-scroll-trigger active" href="/">Главная</a>
                        </li>
                        <li class="nav-item">
                           <a class="nav-link js-scroll-trigger" href="/courses">Курсы</a>
                        </li>
                        <li class="nav-item">
                           <a class="nav-link js-scroll-trigger" href="/tasks">Задачи</a>
                        </li>
                        <li class="nav-item">
                           <a class="nav-link js-scroll-trigger" href="/add-task">Добавить задачу</a>
                        </li>
                        {% if user %}
                           <li class="nav-item">
                              <a class="nav-link js-scroll-trigger" href="/dashboard">Личный кабинет</a>
                           </li>
                           {% else %}
                           <li class="nav-item">
                              <a class="nav-link js-scroll-trigger" href="/sign-in">Войти</a>
                           </li>
                           <li class="nav-item">
                              <a class="nav-link js-scroll-trigger" href="/sign-up">Регистрация</a>
                           </li>
                        {% endif %}
                     </ul>
                  </div>
               </ul>
               
               </div>
            </div>
         </div>
      </nav>
      <style>
         .red{
         color: red;
         }
         .green {
         color: green;
         }
         .none {
         color: black;
         }
         .check_answers {
         color: black;
         }
	 #timer {
	     position: fixed;
	     bottom: 20px;
	     right: 20px;
	     z-index: 10;
	     background-color: #223436;
	     padding: 2px 7px;
	     color: #fff;
	     font-size: 1.2em;
	 }
   ul.ZADACHA,
        ol.ZADACHA {
            margin-left: 20px !important;
            padding-left: 20px !important;
            display: block !important;
            list-style-position: outside !important;
        }

        ul.ZADACHA {
            list-style-type: disc !important;
            visibility: visible !important;
        }

        ol.ZADACHA {
            list-style-type: decimal !important;
            visibility: visible !important;
            counter-reset: item !important;
        }

        ol.ZADACHA[type="a"] {
            list-style-type: lower-alpha !important;
        }

        ul.ZADACHA li,
        ol.ZADACHA li {
            display: list-item !important;
            visibility: visible !important;
            list-style: inherit !important;
            position: relative !important;
        }

        ol.ZADACHA li::before {
            display: inline-block !important;
            position: absolute !important;
            left: -20px !important;
        }
        pre:not([class]) {
            border: 1px solid #ccc;
            background-color: #f5f5f5;
            padding: 10px;
            /* margin-top: -20px; */
            border-radius: 5px;
            overflow-x: auto;
        }
        .markdown img {
            max-width: 100%;
        }
      </style>
      <div id="timer">
	--:--:--
      </div>
      <script>
	class Timer {
	    constructor() {
		this.time = 0;
		this.element = null;
		this.control = true;
		this.callback = null;
		this.timeLimit = 10;
	    }

	    set(time, id, callback = null) {
		this.time = time;
		this.element = document.getElementById(id);
		this.callback = callback;
	    }

	    setTimeLimit(time) {
		this.timeLimit = time;
	    }

	    start(type = 'COUNT_DOWN') {
		this.control = true;

		setTimeout(() => {
		    if(type == 'COUNT_DOWN')
			this.countDown();
		    else if(type == 'COUNT_UP') 
			this.countUp();
		}, 1000);
	    }

	    format() {
		let hours = parseInt(this.time / 3600);
		let timeLeft = this.time - hours * 3600;
		let minutes = parseInt(timeLeft / 60);
		timeLeft = timeLeft - minutes * 60;
		let seconds = timeLeft;
		
		hours = hours.toString();
		minutes = minutes.toString();
		seconds = seconds.toString();
	    
		if (hours.length == 1)
		    hours = '0' + hours;
		if (minutes.length == 1)
		    minutes = '0' + minutes;
		if (seconds.length == 1)
		    seconds = '0' + seconds;
		
		return hours + ':' + minutes + ':' + seconds;
	    }

	    countDown() {
		if(!this.control)
		    return;
		let timerblock = this.element;
		timerblock.innerHTML = this.format();
		timerblock.style.display = 'block';

		if (this.time <= 59) {
		    timerblock.style.color = 'red';
		}
	    
		if (this.time <= 0) {
		    timerblock.innerHTML = 'Время вышло!';
		    this.callback();
		    this.stop();
		}
		else {
		    setTimeout(() => {
			this.countDown();
		    }, 1000);
		    this.time--;
		}
	    }

	    countUp() {
		if(!this.control)
		    return;
		let timerblock = this.element;
		timerblock.innerHTML = this.format();
		timerblock.style.display = 'block';
	    
		if(this.time >= this.timeLimit) {
		    timerblock.innerHTML = 'Timer Limit Exceed!';
		    this.callback();
		    this.stop();
		}
		else {
		    setTimeout(() => {
			this.countUp();
		    }, 1000);
		    this.time++;
		}
	    }
         
	    stop() {
		this.control = false;
	    }
	}
      </script>
      <main id = "task">
        {% for task in tasks %}
          <div class = "task-text">
             <div class = "num">
              <h1> <b> №{{ task[3] }} </b> <span style="color: #999; font-size: 0.8em;">ID: {{ task[0] }}</span></h1>
              <h6> Сложность: \({{ task[2] }}\) <br> Источник: {{ task[4] }}</h6>
             </div>
             {{ task[1]|safe }}
             <div>
                <table border="1" width="30%" cellpadding="5">
                   <tr>
                      <th style="text-align:center; width:50%;">Ваш ответ:</th>
                      <th style="text-align:center" >Правильный ответ:</th>
                   </tr>
                   <tr>
                      <td>
                         <input style="width:100%; margin:auto" 
                            class="{{ task[2] }}" 
                            type="text" 
                            id="task-input-{{ task[0] }}">
                      </td>
                      <td id="task-answer-{{ task[0] }}" style="text-align:center" task-answer="{{ task [5] }}" showing="false">
                         ***
                      </td>
                   </tr>
                </table>
             </div>
          </div>
	  {% endfor %}
          <button
            style="background: #223436; color: white;"
            class="button" 
            id="toggleAnswers" 
            next="Скрыть ответы" 
            onclick="sendAll()">Отправить тест
	  </button>
        <script>
	   {% if time is none %}
             let time = {{ time }};
	   {% else %}
	     let time = 20 * 60;
	   {% endif %}
	   let timer = new Timer();
           timer.set(
	     time * 60,
	     'timer', 
	     sendAll);
	   timer.start();

           function submitAnswer(task_id, ans) {
             fetch("/submit-task", {
               method: "POST",
               credentials: "include",
               headers: {
                 "Content-Type": "application/json",
               },
               body: JSON.stringify({
                 task_id: task_id,
                 ans: ans
               })
             }).then((r) => console.log("GOIDA! Answer received"));
           }

           function changeAnswers(task_id) {
             let ua = document.querySelector(`#task-input-${task_id}`);
             let sa = document.querySelector(`#task-answer-${task_id}`);
             let showing = sa.getAttribute('showing').trim() === "true";
             if(!showing) {
               sa.setAttribute('showing', 'true');
               let answer = sa.getAttribute('task-answer'); 
               sa.innerText = answer;
               if(ua.value.trim() === answer.trim()) {
                 ua.style.color = 'green';
               } else {
                 ua.style.color = 'red';
               }
               submitAnswer(task_id, ua.value.trim());
             } else {
               sa.setAttribute('showing', 'false');
               sa.innerText = "***";
               ua.style.color = 'black';
             }
	     ua.setAttribute('disabled', 'meow');
           }

	   function sendAll() {
	       document
		 .querySelector('#toggleAnswers')
		 .setAttribute('disabled', 'meow');	
	       for(let i = 0; i < 50; i++) {
	           try { changeAnswers(i); }
		   catch {}
	       }
	   }
        </script>
      </main>
      <!-- ALL JS FILES -->
      <script src="{{ url_for('static', filename='js/all.js') }}"></script>
      <!-- Camera Slider -->
      <script src="{{ url_for('static', filename='js/jquery.mobile.customized.min.js') }}"></script>
      <script src="{{ url_for('static', filename='js/jquery.easing.1.3.js') }}"></script>
      <script src="{{ url_for('static', filename='js/parallaxie.js') }}"></script>
      <script src="{{ url_for('static', filename='js/headline.js') }}"></script>
      <!-- Contact form JavaScript -->
      <script src="{{ url_for('static', filename='js/jqBootstrapValidation.js') }}"></script>
      <script src="{{ url_for('static', filename='js/contact_me.js') }}"></script>
      <!-- ALL PLUGINS -->
      <script src="{{ url_for('static', filename='js/owl.carousel.js') }}"></script>
      <script src="{{ url_for('static', filename='js/portfolio.js') }}"></script>
      <script src="{{ url_for('static', filename='js/custom.js') }}"></script>
      <script src="{{ url_for('static', filename='js/jquery.vide.js') }}"></script>
   </body>
</html>

